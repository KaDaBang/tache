<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tache &#8212; tache 0.0.1 文档</title>
    
    <link rel="stylesheet" href="static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="Tag 详细用法" href="advance_tag.html" />
   
  <link rel="stylesheet" href="static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tache">
<span id="tache"></span><h1>Tache<a class="headerlink" href="#tache" title="永久链接至标题">¶</a></h1>
<p>Tache 是一个 Python 的缓存框架。它基于如下的目标而设计:</p>
<ul class="simple">
<li>同时支持 Python2 和 Python3</li>
<li>支持缓存普通函数/实例方法/类方法/静态方法</li>
<li>支持 Batch 批量缓存</li>
<li>支持基于 Tag 的缓存和失效</li>
<li>支持基于参数显式声明 key 格式</li>
</ul>
<p><a class="reference external" href="http://zhihu.github.io/tache">Documention</a></p>
<p><a class="reference external" href="https://github.com/zhihu/tache">项目地址</a></p>
<div class="section" id="contents">
<span id="contents"></span><h2>Contents<a class="headerlink" href="#contents" title="永久链接至标题">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="advance_tag.html">Tag 详细用法</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_kwargs.html">使用关键字参数</a></li>
<li class="toctree-l1"><a class="reference internal" href="cache_null_and_miss.html">Cache 空值与缓存穿透</a></li>
</ul>
</div>
</div>
<div class="section" id="features">
<span id="features"></span><h2>Features<a class="headerlink" href="#features" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li>默认缓存空值，防止穿透</li>
<li>基于tag 批量失效缓存</li>
<li>batch 批量缓存</li>
<li>支持 <code class="docutils literal"><span class="pre">YAML</span></code> <code class="docutils literal"><span class="pre">JSON</span></code> <code class="docutils literal"><span class="pre">PICKLE</span></code> 多种 Backend Serializer</li>
</ul>
</div>
<div class="section" id="getting-started">
<span id="getting-started"></span><h2>Getting Started<a class="headerlink" href="#getting-started" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li>基本用法</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">fakeredis</span>
<span class="kn">from</span> <span class="nn">tache</span> <span class="k">import</span> <span class="n">RedisCache</span>

<span class="n">redis_client</span> <span class="o">=</span> <span class="n">fakeredis</span><span class="o">.</span><span class="n">FakeStrictRedis</span><span class="p">()</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">RedisCache</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">redis_client</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;JSON&quot;</span><span class="p">)</span>

<span class="nd">@cache</span><span class="o">.</span><span class="n">cached</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>

<span class="n">result1</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="c1"># 缓存生效值不变</span>
<span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="n">result1</span>
<span class="c1"># 失效缓存</span>
<span class="n">add</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">!=</span> <span class="n">result1</span>
</pre></div>
</div>
<ul class="simple">
<li>基于 tag 的批量缓存失效</li>
</ul>
<p>tag 可以是固定也可以是动态的，其中动态参数代表在函数中的参数位置。
失效某个 tag 时，代表这个函数下拥有相同 tag 的缓存全部失效。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nd">@cache</span><span class="o">.</span><span class="n">cached</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>

<span class="n">result1</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> 
<span class="n">result2</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">add</span><span class="o">.</span><span class="n">invalidate_tag</span><span class="p">(</span><span class="s2">&quot;a:5&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result1</span> <span class="o">!=</span> <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> 
<span class="k">assert</span> <span class="n">result2</span> <span class="o">!=</span> <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>refresh 刷新缓存</li>
</ul>
<p>当调用refresh 时，将会重新刷新缓存并返回最新值。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@cache</span><span class="o">.</span><span class="n">cached</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">12</span>
<span class="k">assert</span> <span class="n">a</span><span class="o">.</span><span class="n">extra</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">13</span>
<span class="k">assert</span> <span class="n">a</span><span class="o">.</span><span class="n">extra</span> <span class="o">==</span> <span class="mi">2</span>
</pre></div>
</div>
<ul class="simple">
<li>batch 缓存模式</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nd">@cache</span><span class="o">.</span><span class="n">batch</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_comments</span><span class="p">(</span><span class="o">*</span><span class="n">comment_ids</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">get_comment</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comment_ids</span><span class="p">]</span>

<span class="n">get_comments</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># no cache, 调用完毕全部缓存</span>
<span class="n">get_comments</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="c1"># 2,3,4,5 从缓存中取，6 在调用完缓存</span>
<span class="n">get_comments</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># 失效 3,4,5 的缓存</span>
</pre></div>
</div>
<ul class="simple">
<li>显式声明 Key</li>
</ul>
<p>Tache 允许你显式声明 Key 的生成规则， 不论代码如何重构, 生成的 key 都不会改变。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">B</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@cache</span><span class="o">.</span><span class="n">cached</span><span class="p">(</span><span class="s2">&quot;counter.B.add|</span><span class="si">{0}</span><span class="s2">-</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>
</div>
<div class="section" id="notice">
<span id="notice"></span><h2>Notice<a class="headerlink" href="#notice" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li>支持 <code class="docutils literal"><span class="pre">classmethod/staticmethod</span></code> 描述符, 但在使用 <code class="docutils literal"><span class="pre">classmethod</span></code> 时目前必须把
<code class="docutils literal"><span class="pre">classmethod</span></code> 放在内层</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AC</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="nd">@cache</span><span class="o">.</span><span class="n">cached</span><span class="p">()</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>设置 namespace, 处理对象属性修改的问题</li>
</ul>
<p>key 的生成规则默认为 <code class="docutils literal"><span class="pre">namespace:module.classname.func|arg1-arg2|tag1-tag2</span></code>。
其中 <code class="docutils literal"><span class="pre">namespace</span></code> 为空, <code class="docutils literal"><span class="pre">classname</span></code> 不存在时也为空。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@cache</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</pre></div>
</div>
<p>这个例子中，如果数据库字段发生更改，可以通过修改 namespace 的方式，让新老代码使用不同的缓存结果。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">內容目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tache</a><ul>
<li><a class="reference internal" href="#contents">Contents</a></li>
<li><a class="reference internal" href="#features">Features</a></li>
<li><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li><a class="reference internal" href="#notice">Notice</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="#">Documentation overview</a><ul>
      <li>Next: <a href="advance_tag.html" title="下一章">Tag 详细用法</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="sources/index.md.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="转向" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, wayhome.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="sources/index.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>